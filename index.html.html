
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAL Soluciones Tecnológicas - Cotizador</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
        .gal-bg {
            background-color: #1a4d8c; /* GAL Blue */
        }
        .gal-text-primary {
            color: #1a4d8c;
        }
        .input-price::-webkit-outer-spin-button,
        .input-price::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-price {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header y Navegación -->
    <header class="gal-bg text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold flex items-center">
                    <!-- Placeholder para Logo -->
                    <svg class="w-8 h-8 mr-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 12a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zm-4-4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm6.532-6.532a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 11-2 0v-1a1 1 0 112 0v1zm-2 5a1 1 0 002 0v-1a1 1 0 10-2 0v1zm4.532-3.532a1 1 0 00-1.414 0l-.707.707a1 1 0 101.414 1.414l.707-.707a1 1 0 000-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    GAL Soluciones Tecnológicas
                </h1>
                <p class="text-sm italic opacity-80">Garantía, Asesoría, Lealtad</p>
            </div>
            <nav class="flex space-x-4">
                <button onclick="changeView('home')" class="nav-button bg-white text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200 transition">Inicio</button>
                <button onclick="changeView('clientes')" class="nav-button bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition">Clientes</button>
                <button onclick="changeView('cotizaciones')" class="nav-button bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition">Cotización</button>
                <button onclick="changeView('inventario')" class="nav-button bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition">Inventario / Precios</button>
            </nav>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="flex-grow p-6">
        <div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow-2xl">

            <!-- Mensaje de Usuario y Estado de Auth -->
            <div id="auth-status" class="mb-4 p-3 bg-blue-100 border border-blue-300 text-blue-800 rounded-lg text-sm">
                Cargando estado de la aplicación...
            </div>

            <!-- 1. VISTA INICIO -->
            <section id="home-view" class="view">
                <h2 class="text-3xl font-bold gal-text-primary mb-6">Panel de Bienvenida</h2>
                
                <!-- Hora y Fecha -->
                <div class="text-center p-6 bg-gray-50 border border-gray-200 rounded-lg mb-8">
                    <p class="text-lg text-gray-600">Fecha y Hora Actual:</p>
                    <p id="fecha-hora" class="text-5xl font-extrabold gal-text-primary mt-2">--:--</p>
                </div>

                <!-- Accesos Rápidos -->
                <div class="flex justify-center space-x-6">
                    <button onclick="changeView('clientes')" class="bg-green-500 text-white p-4 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105">Gestión de Clientes</button>
                    <button onclick="changeView('cotizaciones')" class="bg-yellow-500 text-white p-4 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105">Crear Cotización</button>
                    <button onclick="changeView('inventario')" class="bg-red-500 text-white p-4 rounded-xl shadow-md hover:shadow-lg transition transform hover:scale-105">Administrar Precios</button>
                </div>
            </section>

            <!-- 2. VISTA CLIENTES (IDÉNTICA A LA VERSIÓN ANTERIOR) -->
            <section id="clientes-view" class="view hidden">
                <h2 class="text-3xl font-bold gal-text-primary mb-6">Gestión de Clientes</h2>

                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Formulario de Registro de Clientes -->
                    <div class="md:col-span-1 p-6 border rounded-xl shadow-inner bg-gray-50">
                        <h3 class="text-xl font-semibold mb-4">Registrar Nuevo Cliente</h3>
                        <form id="client-form" class="space-y-4">
                            <input type="text" id="nombre-completo" placeholder="Nombre completo" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="alias" placeholder="Alias" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="identificacion" placeholder="Identificación" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="tel" id="telefono" placeholder="Teléfono" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="direccion" placeholder="Dirección" required class="w-full p-2 border border-gray-300 rounded-lg">
                            <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">Guardar Cliente</button>
                        </form>
                        <button id="import-btn" class="mt-4 w-full bg-gray-300 text-gray-800 p-3 rounded-lg hover:bg-gray-400 transition">Importar Base de Datos</button>
                        <p id="client-message" class="mt-3 text-sm hidden"></p>
                    </div>

                    <!-- Base de Datos de Clientes (Tabla) -->
                    <div class="md:col-span-2 overflow-x-auto">
                        <h3 class="text-xl font-semibold mb-4">Clientes Registrados</h3>
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
                            <thead class="gal-bg text-white">
                                <tr>
                                    <th class="py-3 px-4 text-left">Nombre</th>
                                    <th class="py-3 px-4 text-left">Alias</th>
                                    <th class="py-3 px-4 text-left">ID</th>
                                    <th class="py-3 px-4 text-left">Teléfono</th>
                                    <th class="py-3 px-4 text-left">Dirección</th>
                                </tr>
                            </thead>
                            <tbody id="clientes-list">
                                <!-- Datos de clientes se insertarán aquí por JavaScript -->
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando clientes...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 3. VISTA COTIZACIONES (LÓGICA ACTUALIZADA) -->
            <section id="cotizaciones-view" class="view hidden">
                <h2 class="text-3xl font-bold gal-text-primary mb-6">Generador de Cotizaciones</h2>

                <!-- Controladores de la Cotización -->
                <div class="bg-gray-100 p-6 rounded-xl shadow-inner mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Datos Generales de la Cotización</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <!-- Fecha (Mostrar la actual) -->
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Fecha de Realización</label>
                            <input type="text" id="quote-date" class="w-full p-2 border border-gray-300 rounded-lg bg-white" readonly>
                        </div>
                        <!-- Cliente -->
                        <div class="col-span-1">
                            <label for="select-client" class="block text-sm font-medium text-gray-700">Seleccionar Cliente</label>
                            <select id="select-client" class="w-full p-2 border border-gray-300 rounded-lg" required>
                                <option value="" disabled selected>Cargando clientes...</option>
                            </select>
                        </div>
                        <!-- Tipo de Cotización -->
                        <div class="col-span-1">
                            <label for="quote-type" class="block text-sm font-medium text-gray-700">Tipo de Cotización</label>
                            <select id="quote-type" class="w-full p-2 border rounded-lg">
                                <option value="analog-cameras" selected>Cámaras Análogas (CCTV)</option>
                                <option value="ip-cameras" disabled>Cámaras IP (Próximamente)</option>
                                <option value="internet-network" disabled>Red de Internet (Próximamente)</option>
                                <option value="emt-piping" disabled>Tubería EMT (Próximamente)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Detalle de Cotización: Cámaras Análogas -->
                <div id="analog-cameras-section">
                    <h3 class="text-2xl font-bold gal-text-primary mb-6 border-b pb-2">Detalle: Sistema de Cámaras Análogas</h3>

                    <form id="analog-quote-form" class="space-y-6">

                        <!-- SECCIÓN CÁMARAS -->
                        <div class="p-4 border rounded-xl shadow-md bg-white">
                            <h4 class="text-lg font-semibold mb-3 border-b pb-1 text-blue-800">1. Cámaras y Grabador (DVR)</h4>
                            
                            <div class="grid md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label for="num-cameras" class="block text-sm font-medium text-gray-700">Cantidad de Cámaras</label>
                                    <input type="number" id="num-cameras" value="1" min="1" class="w-full p-2 border rounded-lg" required onchange="calculateQuote()" oninput="calculateQuote()">
                                </div>
                                <div>
                                    <label for="camera-type" class="block text-sm font-medium text-gray-700">Tipo de Cámara</label>
                                    <select id="camera-type" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="Domo">Domo</option>
                                        <option value="Bala">Bala</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="camera-res" class="block text-sm font-medium text-gray-700">Calidad de Imagen</label>
                                    <select id="camera-res" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="1MP">1MP (720p)</option>
                                        <option value="2MP" selected>2MP (1080p)</option>
                                        <option value="3MP">3MP</option>
                                        <option value="5MP">5MP</option>
                                        <option value="4K">4K (8MP)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="dvr-size" class="block text-sm font-medium text-gray-700">Tamaño de Grabador (CH)</label>
                                    <select id="dvr-size" class="w-full p-2 border rounded-lg" disabled>
                                        <option value="4CH">4CH</option>
                                        <option value="8CH">8CH</option>
                                        <option value="16CH">16CH</option>
                                        <option value="32CH">32CH</option>
                                    </select>
                                    <p class="text-xs text-red-500 mt-1">Se autoajusta a la cantidad de cámaras.</p>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label for="dvr-brand" class="block text-sm font-medium text-gray-700">Marca del Grabador</label>
                                    <select id="dvr-brand" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="HIKVISION">HIKVISION</option>
                                        <option value="DAHUA">DAHUA</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="dvr-quality" class="block text-sm font-medium text-gray-700">Calidad del Grabador (Max Res.)</label>
                                    <select id="dvr-quality" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="2MP" selected>2MP</option>
                                        <option value="4MP">4MP</option>
                                        <option value="5MP">5MP</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="disk-capacity" class="block text-sm font-medium text-gray-700">Capacidad Disco Duro</label>
                                    <select id="disk-capacity" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="1T">1 Tera</option>
                                        <option value="2T" selected>2 Teras</option>
                                        <option value="3T">3 Teras</option>
                                        <option value="4T">4 Teras</option>
                                        <option value="10T">10 Teras</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN CABLEADO E INSTALACIÓN -->
                        <div class="p-4 border rounded-xl shadow-md bg-white">
                            <h4 class="text-lg font-semibold mb-3 border-b pb-1 text-blue-800">2. Cableado e Infraestructura</h4>
                            
                            <div class="grid md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="cable-distance" class="block text-sm font-medium text-gray-700">Distancia Promedio Cámara más Larga (Mts)</label>
                                    <input type="number" id="cable-distance" value="20" min="5" class="w-full p-2 border rounded-lg" onchange="calculateQuote()" oninput="calculateQuote()">
                                    <p class="text-xs text-gray-500 mt-1">Total UTP: <span id="total-utp">0</span> m. Total Eléctrico: <span id="total-electrico">0</span> m.</p>
                                </div>
                                <div>
                                    <label for="cable-utp-cat" class="block text-sm font-medium text-gray-700">Cable UTP Categoría</label>
                                    <select id="cable-utp-cat" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="CAT5">CAT5</option>
                                        <option value="CAT6" selected>CAT6</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="cable-electrico-calibre" class="block text-sm font-medium text-gray-700">Cable Eléctrico Calibre</label>
                                    <select id="cable-electrico-calibre" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="#18">#18</option>
                                        <option value="#16" selected>#16</option>
                                        <option value="#14">#14</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="install-type" class="block text-sm font-medium text-gray-700">Tipo de Instalación</label>
                                    <select id="install-type" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="Canaletas">Canaletas</option>
                                        <option value="EMT" selected>Tubería EMT</option>
                                        <option value="Expuesto">Expuesto con Grapas/Amarras</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="box-type" class="block text-sm font-medium text-gray-700">Tipo de Caja (por Cámara)</label>
                                    <select id="box-type" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="Plástica">Plástica 10x10</option>
                                        <option value="EMT" selected>Metálica EMT</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="cabinet-size" class="block text-sm font-medium text-gray-700">Tamaño Gabinete DVR</label>
                                    <select id="cabinet-size" class="w-full p-2 border rounded-lg" onchange="calculateQuote()">
                                        <option value="Ninguno">Ninguno</option>
                                        <option value="Pequeño" selected>Pequeño</option>
                                        <option value="Mediano">Mediano</option>
                                        <option value="Grande">Grande</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Opción Adicional UPS -->
                            <div class="flex items-center mt-2 p-2 bg-yellow-50 rounded-lg">
                                <input type="checkbox" id="include-ups" class="h-4 w-4 text-yellow-600 border-gray-300 rounded mr-2" onchange="calculateQuote()">
                                <label for="include-ups" class="text-sm font-medium text-gray-700">Incluir UPS (Aumenta tamaño de Gabinete)</label>
                            </div>

                            <!-- Opciones para Tubería EMT (Condicional) -->
                            <div id="emt-options" class="mt-4 p-3 bg-gray-50 border rounded-lg">
                                <h5 class="font-semibold mb-2">Detalle de Tubería EMT (Ingrese Unidades de 3 metros)</h5>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <label for="tubo-1-2" class="block text-sm text-gray-700">Tubos 1/2"</label>
                                        <input type="number" id="tubo-1-2" value="2" min="0" class="w-full p-2 border rounded-lg" onchange="calculateQuote()" oninput="calculateQuote()">
                                    </div>
                                    <div>
                                        <label for="tubo-3-4" class="block text-sm text-gray-700">Tubos 3/4"</label>
                                        <input type="number" id="tubo-3-4" value="0" min="0" class="w-full p-2 border rounded-lg" onchange="calculateQuote()" oninput="calculateQuote()">
                                    </div>
                                    <div>
                                        <label for="tubo-1" class="block text-sm text-gray-700">Tubos 1"</label>
                                        <input type="number" id="tubo-1" value="0" min="0" class="w-full p-2 border rounded-lg" onchange="calculateQuote()" oninput="calculateQuote()">
                                    </div>
                                    <div>
                                        <label for="cajas-transicion" class="block text-sm text-gray-700">Cajas Transición</label>
                                        <input type="number" id="cajas-transicion" value="1" min="0" class="w-full p-2 border rounded-lg" onchange="calculateQuote()" oninput="calculateQuote()">
                                    </div>
                                </div>
                                <p class="text-xs text-blue-500 mt-2">Costo de $5.000 por metro de tubo instalado. Grapas, curvas y uniones se calculan automáticamente.</p>
                            </div>
                        </div>

                    </form>

                    <!-- RESUMEN DE CÁLCULO Y FACTURACIÓN -->
                    <div class="mt-8 p-6 gal-bg text-white rounded-xl shadow-2xl">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2">RESUMEN DE COTIZACIÓN</h3>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- Columna de Ítems y Accesorios -->
                            <div class="space-y-2">
                                <h4 class="text-lg font-semibold mb-2 text-yellow-300">Detalle de Costos Fijos/Accesorios (Materiales)</h4>
                                <p>Costo Cámaras, DVR y DD: <span id="costo-equipos" class="font-bold">0.00</span></p>
                                <p>Costo UPS: <span id="costo-ups" class="font-bold">0.00</span></p>
                                <p>Accesorios por Cámara (Fuentes, Baluns, Tomas, Cajas): <span id="costo-accesorios" class="font-bold">0.00</span></p>
                                <p>Cableado UTP/Eléctrico (Material): <span id="costo-cableado" class="font-bold">0.00</span></p>
                                <p>Gabinete, Pascor y Eléctrico Gabinete: <span id="costo-gabinete" class="font-bold">0.00</span></p>
                            </div>

                            <!-- Columna de Mano de Obra y Totales -->
                            <div class="space-y-2">
                                <h4 class="text-lg font-semibold mb-2 text-yellow-300">Detalle de Mano de Obra</h4>
                                <p>Instalación Puntos de Cámara ($90.000 c/u): <span id="mo-camaras" class="font-bold text-lg">0.00</span></p>
                                <p>Instalación Gabinete y Config. DVR/NVR: <span id="mo-dvr" class="font-bold">0.00</span></p>
                                <p>Mano de Obra Instalación EMT/Canaleta/Expuesto: <span id="mo-instalacion" class="font-bold">0.00</span></p>
                                
                                <p class="pt-4 text-3xl font-extrabold border-t border-yellow-300 mt-4">
                                    TOTAL ESTIMADO (Sin IVA): <span id="total-final">0.00</span>
                                </p>
                            </div>
                        </div>

                        <div class="text-right mt-6">
                            <button onclick="saveQuote()" class="bg-yellow-400 text-gray-900 p-3 rounded-lg font-bold hover:bg-yellow-500 transition shadow-md">
                                Guardar Cotización en Firebase
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 4. VISTA INVENTARIO / PRECIOS (NUEVA SECCIÓN) -->
            <section id="inventario-view" class="view hidden">
                <h2 class="text-3xl font-bold text-red-700 mb-6">Administración de Inventario y Precios</h2>
                <div class="p-6 border rounded-xl shadow-2xl bg-red-50">
                    <p class="text-sm text-red-700 mb-4 font-medium">Última actualización: <span id="last-update-time">N/A</span>. Estos precios son **PÚBLICOS** y se usan en todas las cotizaciones.</p>
                    
                    <form id="prices-form" onsubmit="event.preventDefault(); savePrices();">
                        <div class="space-y-6">
                            
                            <!-- PRECIOS DE CÁMARAS -->
                            <div class="p-4 border border-red-300 rounded-lg bg-white shadow-md">
                                <h3 class="text-xl font-semibold mb-3 text-red-800">Cámaras (Costo Unitario por Resolución)</h3>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <div><label for="price-1MP" class="block text-sm">1MP (720p)</label><input type="number" id="price-1MP" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-2MP" class="block text-sm">2MP (1080p)</label><input type="number" id="price-2MP" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-3MP" class="block text-sm">3MP</label><input type="number" id="price-3MP" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-5MP" class="block text-sm">5MP</label><input type="number" id="price-5MP" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-4K" class="block text-sm">4K (8MP)</label><input type="number" id="price-4K" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                </div>
                            </div>

                            <!-- PRECIOS DE DVRS -->
                            <div class="p-4 border border-red-300 rounded-lg bg-white shadow-md">
                                <h3 class="text-xl font-semibold mb-3 text-red-800">Grabadores DVR (Costo Unitario por Canales)</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><label for="price-4CH" class="block text-sm">4 Canales</label><input type="number" id="price-4CH" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-8CH" class="block text-sm">8 Canales</label><input type="number" id="price-8CH" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-16CH" class="block text-sm">16 Canales</label><input type="number" id="price-16CH" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-32CH" class="block text-sm">32 Canales</label><input type="number" id="price-32CH" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                </div>
                            </div>

                            <!-- PRECIOS DE DISCOS DUROS -->
                            <div class="p-4 border border-red-300 rounded-lg bg-white shadow-md">
                                <h3 class="text-xl font-semibold mb-3 text-red-800">Discos Duros (Costo Unitario por Capacidad)</h3>
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <div><label for="price-1T" class="block text-sm">1 Tera</label><input type="number" id="price-1T" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-2T" class="block text-sm">2 Teras</label><input type="number" id="price-2T" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-3T" class="block text-sm">3 Teras</label><input type="number" id="price-3T" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-4T" class="block text-sm">4 Teras</label><input type="number" id="price-4T" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-10T" class="block text-sm">10 Teras</label><input type="number" id="price-10T" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                </div>
                            </div>
                            
                            <!-- PRECIOS DE ACCESORIOS FIJOS -->
                            <div class="p-4 border border-red-300 rounded-lg bg-white shadow-md">
                                <h3 class="text-xl font-semibold mb-3 text-red-800">Gabinetes y Otros</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div><label for="price-Gabinete-Pequeno" class="block text-sm">Gabinete Pequeño</label><input type="number" id="price-Gabinete-Pequeno" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-Gabinete-Mediano" class="block text-sm">Gabinete Mediano</label><input type="number" id="price-Gabinete-Mediano" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-Gabinete-Grande" class="block text-sm">Gabinete Grande</label><input type="number" id="price-Gabinete-Grande" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                    <div><label for="price-UPS" class="block text-sm">UPS (Costo Único)</label><input type="number" id="price-UPS" min="0" required class="w-full p-2 border rounded-lg input-price"></div>
                                </div>
                            </div>

                        </div>
                        
                        <button type="submit" id="save-prices-btn" class="mt-6 w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 transition">
                            Guardar y Aplicar Precios
                        </button>
                        <p id="prices-message" class="mt-3 text-sm text-center hidden"></p>
                    </form>
                </div>
            </section>


        </div>
    </main>

    <!-- LÓGICA DE LA APLICACIÓN (Javascript con Firebase) -->
    <script type="module">
        // Importar funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales del Canvas (MANDATORIAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-gal-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'loading'; // ID del usuario, esencial para el path de Firestore
        let isAuthReady = false;
        let allClients = []; // Para almacenar clientes y usarlos en el select
        
        // ** NUEVA VARIABLE GLOBAL PARA ALMACENAR PRECIOS **
        let PRODUCTS_PRICES = {
            cameras: {}, dvrs: {}, disks: {}, cabinets: {}, ups: 0, lastUpdated: 'N/A'
        };

        const authStatusEl = document.getElementById('auth-status');
        const clientsListEl = document.getElementById('clientes-list');
        const clientFormEl = document.getElementById('client-form');
        const clientMessageEl = document.getElementById('client-message');
        
        // Elementos de la vista de Inventario
        const pricesFormEl = document.getElementById('prices-form');
        const pricesMessageEl = document.getElementById('prices-message');
        const lastUpdateTimeEl = document.getElementById('last-update-time');
        
        // Elementos de la vista de Cotizaciones
        const dvrSizeEl = document.getElementById('dvr-size');
        const installTypeEl = document.getElementById('install-type');
        const emtOptionsEl = document.getElementById('emt-options');
        const quoteDateEl = document.getElementById('quote-date');

        /**
         * DATOS DE PRODUCTOS Y PRECIOS (DEMO) - Solo Mano de Obra y Accesorios Fijos
         */
        const FIXED_DATA = {
            // Costos de Mano de Obra (MO) - Fijos
            MO_PUNTO_CAMARA: 90000,
            MO_METRO_TUBO_EMT: 5000,
            MO_GABINETE_DVR: 50000, // Instalación Gabinete + Configuración DVR
            
            // Accesorios (Usamos precios estimados para materiales, reemplazar con precios reales)
            ACCESSORIES: {
                FUENTE_2A: 15000,
                VIDEO_BALUN_PAR: 8000,
                TOMA_AEREO: 3000,
                CAJA_PLASTICA: 4000,
                CAJA_EMT: 8000,
                PASCOR_DVR: 5000,
                TOMA_ELECTRICO_GAB: 12000,
                // Materiales por metro/unidad
                CABLE_UTP_METER: 500,
                CABLE_ELECTRICO_METER: 300,
                METRO_CANALETA: 2000, 
                // Ítems EMT - Usados para cálculo de costos de material de instalación
                EMT_TUBOS_3M: 10000, 
                EMT_ACCESORIOS_POR_TUBO: 5000, // Grapas, uniones, etc.
            },
        };


        /**
         * 1. INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN
         */
        const initFirebase = async () => {
            if (!firebaseConfig) {
                // Manejo de error en el editor (sin configuración inyectada)
                authStatusEl.textContent = '⚠️ Configuración de Firebase Pendiente. (Esto es normal en el editor, pero funcionará al ejecutar el Canvas).';
                isAuthReady = true; 
                console.warn("Firebase Config not found. Persistence disabled.");
                
                // Cargar un cliente de prueba y precios de prueba
                allClients = [{ 
                    id: 'demo-client-id', 
                    data: { nombreCompleto: 'Cliente de Prueba', alias: 'DEMO', identificacion: 'N/A', telefono: 'N/A', direccion: 'N/A' } 
                }];
                PRODUCTS_PRICES = {
                    cameras: {'1MP': 50000, '2MP': 80000, '3MP': 120000, '5MP': 180000, '4K': 300000},
                    dvrs: {'4CH': 250000, '8CH': 400000, '16CH': 750000, '32CH': 1500000},
                    disks: {'1T': 180000, '2T': 250000, '3T': 350000, '4T': 450000, '10T': 900000},
                    cabinets: {'Pequeño': 60000, 'Mediano': 120000, 'Grande': 200000},
                    ups: 350000,
                    lastUpdated: 'MODO DEMO'
                };
                
                clientsListEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-orange-500">Funcionalidad de base de datos deshabilitada. Usando cliente DEMO y precios de prueba.</td></tr>';
                loadClientsDropdown();
                updatePricesForm(); // Cargar los precios demo en el formulario
                calculateQuote(); // Recalcular con precios demo

                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase App y Firestore inicializados.");

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `✅ Autenticado. User ID: ${userId}. App ID: ${appId}.`;
                    } else {
                        userId = crypto.randomUUID(); 
                        authStatusEl.textContent = `⚠️ Sesión anónima. ID local: ${userId.substring(0, 8)}...`;
                    }
                    isAuthReady = true;
                    // Una vez autenticado, cargar clientes y precios
                    loadClients();
                    loadPrices(); 
                });

            } catch (error) {
                authStatusEl.textContent = `❌ Error de conexión: ${error.message}`;
                console.error("Error en initFirebase:", error);
            }
        };
        
        /**
         * 2. LÓGICA DE INVENTARIO Y PRECIOS
         */

        // Ruta de colección de Precios (Datos Públicos/Compartidos)
        const getPricesDocumentRef = () => {
            if (!db) return null;
            // Path: /artifacts/{appId}/public/data/precios/current
            const path = `artifacts/${appId}/public/data/precios`;
            return doc(db, path, 'current');
        };

        // Cargar precios desde Firestore y escuchar cambios
        const loadPrices = () => {
            if (!db) return;
            
            const pricesDocRef = getPricesDocumentRef();
            if (!pricesDocRef) return;
            
            onSnapshot(pricesDocRef, (doc) => {
                if (doc.exists()) {
                    PRODUCTS_PRICES = doc.data();
                    console.log("Precios cargados:", PRODUCTS_PRICES);
                } else {
                    // Inicializar si el documento no existe
                    console.log("No se encontró documento de precios. Inicializando con ceros.");
                    PRODUCTS_PRICES = {
                        cameras: {'1MP': 0, '2MP': 0, '3MP': 0, '5MP': 0, '4K': 0},
                        dvrs: {'4CH': 0, '8CH': 0, '16CH': 0, '32CH': 0},
                        disks: {'1T': 0, '2T': 0, '3T': 0, '4T': 0, '10T': 0},
                        cabinets: {'Pequeño': 0, 'Mediano': 0, 'Grande': 0},
                        ups: 0,
                        lastUpdated: 'N/A'
                    };
                }
                updatePricesForm(); // Rellenar formulario de inventario
                calculateQuote();    // Recalcular cotización con nuevos precios
            }, (error) => {
                console.error("Error al cargar precios:", error);
                showMessagePrices(`Error al cargar precios: ${error.message}`, 'bg-red-100 text-red-800');
            });
        };

        // Rellenar los campos del formulario de Inventario con los precios actuales
        const updatePricesForm = () => {
            if (!pricesFormEl) return;
            
            // Cámaras
            Object.entries(PRODUCTS_PRICES.cameras || {}).forEach(([key, value]) => {
                const el = document.getElementById(`price-${key}`);
                if (el) el.value = value;
            });
            // DVRs
            Object.entries(PRODUCTS_PRICES.dvrs || {}).forEach(([key, value]) => {
                const el = document.getElementById(`price-${key}`);
                if (el) el.value = value;
            });
            // Discos Duros
            Object.entries(PRODUCTS_PRICES.disks || {}).forEach(([key, value]) => {
                const el = document.getElementById(`price-${key}`);
                if (el) el.value = value;
            });
            // Gabinetes
            Object.entries(PRODUCTS_PRICES.cabinets || {}).forEach(([key, value]) => {
                const el = document.getElementById(`price-Gabinete-${key}`);
                if (el) el.value = value;
            });
            // UPS
            const upsEl = document.getElementById('price-UPS');
            if (upsEl) upsEl.value = PRODUCTS_PRICES.ups || 0;

            // Mostrar hora de última actualización
            lastUpdateTimeEl.textContent = PRODUCTS_PRICES.lastUpdated || 'Nunca';
        };

        // Guardar precios en Firestore
        window.savePrices = async () => {
             if (!db) {
                showMessagePrices("ERROR: La base de datos no está activa en este entorno. Ejecute el Canvas para guardar.", 'bg-red-100 text-red-800');
                return;
            }

            // 1. Recolectar datos del formulario
            const newPrices = {
                cameras: {
                    '1MP': parseInt(document.getElementById('price-1MP').value) || 0,
                    '2MP': parseInt(document.getElementById('price-2MP').value) || 0,
                    '3MP': parseInt(document.getElementById('price-3MP').value) || 0,
                    '5MP': parseInt(document.getElementById('price-5MP').value) || 0,
                    '4K': parseInt(document.getElementById('price-4K').value) || 0,
                },
                dvrs: {
                    '4CH': parseInt(document.getElementById('price-4CH').value) || 0,
                    '8CH': parseInt(document.getElementById('price-8CH').value) || 0,
                    '16CH': parseInt(document.getElementById('price-16CH').value) || 0,
                    '32CH': parseInt(document.getElementById('price-32CH').value) || 0,
                },
                disks: {
                    '1T': parseInt(document.getElementById('price-1T').value) || 0,
                    '2T': parseInt(document.getElementById('price-2T').value) || 0,
                    '3T': parseInt(document.getElementById('price-3T').value) || 0,
                    '4T': parseInt(document.getElementById('price-4T').value) || 0,
                    '10T': parseInt(document.getElementById('price-10T').value) || 0,
                },
                cabinets: {
                    'Pequeño': parseInt(document.getElementById('price-Gabinete-Pequeno').value) || 0,
                    'Mediano': parseInt(document.getElementById('price-Gabinete-Mediano').value) || 0,
                    'Grande': parseInt(document.getElementById('price-Gabinete-Grande').value) || 0,
                },
                ups: parseInt(document.getElementById('price-UPS').value) || 0,
                lastUpdated: new Date().toLocaleString('es-ES')
            };

            // 2. Guardar en Firestore
            try {
                const pricesDocRef = getPricesDocumentRef();
                if (!pricesDocRef) throw new Error("Referencia de precios no disponible.");
                
                // Usar setDoc para reemplazar completamente el documento de precios
                await setDoc(pricesDocRef, newPrices);
                
                showMessagePrices("✅ Precios guardados y aplicados a las cotizaciones.", 'bg-green-100 text-green-800');
            } catch (error) {
                showMessagePrices(`❌ Error al guardar precios: ${error.message}`, 'bg-red-100 text-red-800');
                console.error("Error al guardar precios:", error);
            }
        };
        
        // Mostrar un mensaje temporal en la vista de Precios
        const showMessagePrices = (text, classes) => {
            pricesMessageEl.textContent = text;
            pricesMessageEl.className = `mt-3 p-2 text-sm rounded-lg text-center ${classes}`;
            pricesMessageEl.classList.remove('hidden');
            setTimeout(() => pricesMessageEl.classList.add('hidden'), 5000);
        };

        /**
         * 3. LÓGICA DE INTERFAZ (VISTAS Y HORA)
         */

        window.changeView = (targetView) => {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${targetView}-view`).classList.remove('hidden');
        };

        const actualizarFechaHora = () => {
            const ahora = new Date();
            const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
            const opcionesHora = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };

            const fecha = ahora.toLocaleDateString('es-ES', opcionesFecha);
            const hora = ahora.toLocaleTimeString('es-ES', opcionesHora);

            document.getElementById('fecha-hora').textContent = `${fecha} - ${hora}`;
        }

        /**
         * 4. LÓGICA DE CLIENTES (CREATE y READ - onSnapshot)
         */

        const getClientsCollectionRef = () => {
            if (!db) return null;
            const path = `artifacts/${appId}/users/${userId}/clientes`;
            return collection(db, path);
        };
        
        const loadClientsDropdown = () => {
            const selectClientEl = document.getElementById('select-client');
            selectClientEl.innerHTML = '<option value="" disabled selected>Seleccione un cliente</option>';
            
            if (allClients.length === 0) {
                selectClientEl.innerHTML = '<option value="" disabled>No hay clientes, registre uno primero.</option>';
                return;
            }

            allClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.data.nombreCompleto} (${client.data.alias})`;
                selectClientEl.appendChild(option);
            });
            if (allClients.length === 1 && allClients[0].id === 'demo-client-id') {
                selectClientEl.value = 'demo-client-id';
            }
        };

        const addClient = async (e) => {
            e.preventDefault();
            if (!db) {
                showMessage("ERROR: La base de datos no está activa en este entorno. Ejecute el Canvas para guardar.", 'bg-red-100 text-red-800');
                return;
            }
            if (!isAuthReady || !db) return;
            const newClient = {
                nombreCompleto: document.getElementById('nombre-completo').value,
                alias: document.getElementById('alias').value,
                identificacion: document.getElementById('identificacion').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                createdAt: new Date(),
            };
            try {
                const clientsRef = getClientsCollectionRef();
                if (!clientsRef) throw new Error("Referencia de colección no disponible.");
                await addDoc(clientsRef, newClient);
                clientFormEl.reset();
                showMessage("Cliente guardado con éxito.", 'bg-green-100 text-green-800');
            } catch (error) {
                showMessage(`Error al guardar cliente: ${error.message}`, 'bg-red-100 text-red-800');
                console.error("Error al añadir documento:", error);
            }
        };

        const showMessage = (text, classes) => {
            clientMessageEl.textContent = text;
            clientMessageEl.className = `mt-3 p-2 text-sm rounded-lg ${classes}`;
            clientMessageEl.classList.remove('hidden');
            setTimeout(() => clientMessageEl.classList.add('hidden'), 3000);
        };


        const loadClients = () => {
            if (!db) return;
            if (!isAuthReady) return;
            const clientsRef = getClientsCollectionRef();
            if (!clientsRef) return;
            const q = query(clientsRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                let html = '';
                allClients = [];
                if (snapshot.empty) {
                    html = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay clientes registrados aún.</td></tr>';
                } else {
                    snapshot.forEach(doc => {
                        const client = doc.data();
                        allClients.push({ id: doc.id, data: client }); 
                        html += `
                            <tr class="hover:bg-gray-50 border-b">
                                <td class="py-3 px-4">${client.nombreCompleto}</td>
                                <td class="py-3 px-4 text-sm font-medium">${client.alias}</td>
                                <td class="py-3 px-4 text-sm">${client.identificacion}</td>
                                <td class="py-3 px-4">${client.telefono}</td>
                                <td class="py-3 px-4 text-sm">${client.direccion}</td>
                            </tr>
                        `;
                    });
                }
                clientsListEl.innerHTML = html;
                loadClientsDropdown(); 
            }, (error) => {
                console.error("Error al cargar clientes:", error);
                clientsListEl.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error: ${error.message}</td></tr>`;
            });
        };

        /**
         * 5. LÓGICA DE COTIZACIONES (ACTUALIZADA CON PRODUCTOS_PRICES)
         */

        const formatCurrency = (value) => {
            const numValue = parseFloat(value) || 0;
            return numValue.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
        };


        window.calculateQuote = () => {
            // Recolección de inputs
            const N = parseInt(document.getElementById('num-cameras').value) || 0;
            const distance = parseInt(document.getElementById('cable-distance').value) || 0;
            const installType = installTypeEl.value;
            const boxType = document.getElementById('box-type').value;
            const cabinetSize = document.getElementById('cabinet-size').value;
            const includeUPS = document.getElementById('include-ups').checked;
            const cameraRes = document.getElementById('camera-res').value;
            const diskCapacity = document.getElementById('disk-capacity').value;
            
            // --- CÁLCULOS AUTOMÁTICOS DE REQUERIMIENTOS ---
            
            // 1. Tamaño de DVR: Se autoajusta
            let dvrSize;
            if (N === 0) dvrSize = '4CH';
            else if (N <= 4) dvrSize = '4CH';
            else if (N <= 8) dvrSize = '8CH';
            else if (N <= 16) dvrSize = '16CH';
            else dvrSize = '32CH';
            dvrSizeEl.value = dvrSize;
            
            const totalUTP = N * distance;
            const totalElectrico = N * distance;
            document.getElementById('total-utp').textContent = totalUTP;
            document.getElementById('total-electrico').textContent = totalElectrico;
            emtOptionsEl.classList.toggle('hidden', installType !== 'EMT');

            const numTubosMedio = parseInt(document.getElementById('tubo-1-2')?.value) || 0;
            const numTubosTresCuartos = parseInt(document.getElementById('tubo-3-4')?.value) || 0;
            const numTubosUno = parseInt(document.getElementById('tubo-1')?.value) || 0;
            const numCajasTransicion = parseInt(document.getElementById('cajas-transicion')?.value) || 0;
            const totalTubos = numTubosMedio + numTubosTresCuartos + numTubosUno;

            // --- CÁLCULO DE COSTOS (Materiales) ---

            let totalCostoMaterial = 0;
            let totalManoObra = 0;
            let costoEquipos = 0;
            let costoUPS = 0;
            
            // A. Costo de Equipos (Cámaras, DVR, Disco Duro)
            const cameraPrice = PRODUCTS_PRICES.cameras ? (PRODUCTS_PRICES.cameras[cameraRes] || 0) : 0;
            const dvrPrice = PRODUCTS_PRICES.dvrs ? (PRODUCTS_PRICES.dvrs[dvrSize] || 0) : 0;
            const diskPrice = PRODUCTS_PRICES.disks ? (PRODUCTS_PRICES.disks[diskCapacity] || 0) : 0;
            
            costoEquipos = (cameraPrice * N) + dvrPrice + diskPrice;
            totalCostoMaterial += costoEquipos;
            document.getElementById('costo-equipos').textContent = formatCurrency(costoEquipos);

            // B. Costo UPS (Solo si se incluye)
            if (includeUPS) {
                costoUPS = PRODUCTS_PRICES.ups || 0;
            }
            totalCostoMaterial += costoUPS;
            document.getElementById('costo-ups').textContent = formatCurrency(costoUPS);
            
            // C. Costo de Accesorios por Cámara (Fijos)
            let costoAccesorios = N * (FIXED_DATA.ACCESSORIES.FUENTE_2A + FIXED_DATA.ACCESSORIES.VIDEO_BALUN_PAR + FIXED_DATA.ACCESSORIES.TOMA_AEREO);
            
            if (boxType === 'Plástica') {
                costoAccesorios += N * FIXED_DATA.ACCESSORIES.CAJA_PLASTICA;
            } else if (boxType === 'EMT') {
                costoAccesorios += N * FIXED_DATA.ACCESSORIES.CAJA_EMT;
            }
            totalCostoMaterial += costoAccesorios;
            document.getElementById('costo-accesorios').textContent = formatCurrency(costoAccesorios);

            
            // D. Costo Cableado (Materiales Fijos)
            let costoCableado = (totalUTP * FIXED_DATA.ACCESSORIES.CABLE_UTP_METER) + (totalElectrico * FIXED_DATA.ACCESSORIES.CABLE_ELECTRICO_METER);
            
            if (installType === 'Canaletas') {
                const numCanaletas = Math.ceil(totalUTP / 2); 
                costoCableado += numCanaletas * FIXED_DATA.ACCESSORIES.METRO_CANALETA * 2;
            }
            if (installType === 'EMT' && totalTubos > 0) {
                let costoTubos = totalTubos * FIXED_DATA.ACCESSORIES.EMT_TUBOS_3M;
                let costoAccesoriosTubos = totalTubos * FIXED_DATA.ACCESSORIES.EMT_ACCESORIOS_POR_TUBO;
                let costoCajasEMT = numCajasTransicion * (FIXED_DATA.ACCESSORIES.CAJA_EMT * 2);
                costoCableado += costoTubos + costoAccesoriosTubos + costoCajasEMT;
            }
            totalCostoMaterial += costoCableado;
            document.getElementById('costo-cableado').textContent = formatCurrency(costoCableado);


            // E. Costo Gabinete y Pascor (Usando precios de Inventario)
            let costoGabinete = 0;
            if (cabinetSize !== 'Ninguno') {
                const cabinetPrice = PRODUCTS_PRICES.cabinets ? (PRODUCTS_PRICES.cabinets[cabinetSize] || 0) : 0;
                costoGabinete = cabinetPrice;
                costoGabinete += FIXED_DATA.ACCESSORIES.TOMA_ELECTRICO_GAB; 
                costoGabinete += FIXED_DATA.ACCESSORIES.PASCOR_DVR;
            }
            totalCostoMaterial += costoGabinete;
            document.getElementById('costo-gabinete').textContent = formatCurrency(costoGabinete);

            // --- CÁLCULO DE MANO DE OBRA (MO - Fijos) ---
            
            // F. MO Puntos de Cámara
            let moCamaras = N * FIXED_DATA.MO_PUNTO_CAMARA;
            totalManoObra += moCamaras;
            document.getElementById('mo-camaras').textContent = formatCurrency(moCamaras);

            // G. MO Gabinete y Configuración DVR/NVR
            let moDVR = 0;
            if (cabinetSize !== 'Ninguno') {
                moDVR = FIXED_DATA.MO_GABINETE_DVR;
            }
            totalManoObra += moDVR;
            document.getElementById('mo-dvr').textContent = formatCurrency(moDVR);

            // H. MO Instalación 
            let moInstalacion = 0;
            if (installType === 'EMT') {
                moInstalacion = totalTubos * 3 * FIXED_DATA.MO_METRO_TUBO_EMT; 
            } else if (installType === 'Canaletas') {
                moInstalacion = Math.ceil(totalUTP / 2) * 5000;
            }
            totalManoObra += moInstalacion;
            document.getElementById('mo-instalacion').textContent = formatCurrency(moInstalacion);
            
            // --- TOTAL FINAL ---

            const totalFinal = totalCostoMaterial + totalManoObra;
            document.getElementById('total-final').textContent = formatCurrency(totalFinal);
        };

        const cleanCurrency = (text) => {
            return parseFloat(text.replace(/[$.COP]/g, '').replace(',', '.').trim()) || 0;
        }

        window.saveQuote = () => {
            const clienteId = document.getElementById('select-client').value;
            const clienteSeleccionado = allClients.find(c => c.id === clienteId);
            
            if (!clienteId || !clienteSeleccionado) {
                showMessage("Por favor, seleccione un cliente antes de guardar.", 'bg-red-100 text-red-800');
                return;
            }
            
            const quoteData = {
                date: quoteDateEl.value,
                clientId: clienteId,
                clientName: clienteSeleccionado.data.nombreCompleto,
                quoteType: document.getElementById('quote-type').value,
                
                details: {
                    numCameras: parseInt(document.getElementById('num-cameras').value) || 0,
                    cameraType: document.getElementById('camera-type').value,
                    installType: document.getElementById('install-type').value,
                    totalUtpMeters: parseInt(document.getElementById('total-utp').textContent) || 0,
                },
                costs: {
                    material: cleanCurrency(document.getElementById('costo-equipos').textContent) + cleanCurrency(document.getElementById('costo-accesorios').textContent) + cleanCurrency(document.getElementById('costo-cableado').textContent) + cleanCurrency(document.getElementById('costo-gabinete').textContent) + cleanCurrency(document.getElementById('costo-ups').textContent),
                    manoObra: cleanCurrency(document.getElementById('mo-camaras').textContent) + cleanCurrency(document.getElementById('mo-dvr').textContent) + cleanCurrency(document.getElementById('mo-instalacion').textContent),
                    total: cleanCurrency(document.getElementById('total-final').textContent),
                },
                createdAt: new Date()
            };

            if (db) {
                // Faltaría la lógica de guardado de la cotización
                showMessage("Cotización guardada con éxito. (Falta implementación de guardado final)", 'bg-blue-100 text-blue-800');
            } else {
                showMessage(`Cotización de ${formatCurrency(quoteData.costs.total)} para ${clienteSeleccionado.data.alias} generada. (Guardado real deshabilitado en editor)`, 'bg-yellow-100 text-yellow-800');
            }
        };

        const setupQuoteListeners = () => {
            // Establecer la fecha actual
            const today = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            quoteDateEl.value = today;

            // La función calculateQuote ahora se ejecuta después de cargar los precios
            calculateQuote();
        };

        /**
         * 6. EJECUCIÓN INICIAL
         */
        document.addEventListener('DOMContentLoaded', () => {
            actualizarFechaHora();
            setInterval(actualizarFechaHora, 1000);

            initFirebase();

            clientFormEl.addEventListener('submit', addClient);

            document.getElementById('import-btn').addEventListener('click', () => {
                showMessage("Funcionalidad de importación no implementada aún.", 'bg-yellow-100 text-yellow-800');
            });

            setupQuoteListeners();

            changeView('home');
        });

    </script>
</body>
</html>
